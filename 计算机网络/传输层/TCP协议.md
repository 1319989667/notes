# TCP报文段形式

![image-20230302162943273](C:\Users\Kirua\AppData\Roaming\Typora\typora-user-images\image-20230302162943273.png)

# 三次握手

![image-20230302163108620](C:\Users\Kirua\AppData\Roaming\Typora\typora-user-images\image-20230302163108620.png)

**第一次握手([SYN], Seq = x)**
 客户端发送一个SYN标记的包，Seq初始序列号x，发送完成后`客户端`进入`SYN_SEND`状态。

**第二次握手([SYN,ACK], Seq = y, ACK = x + 1)**
 服务器返回确认包(ACK)应答，同时还要发送一个SYN包回去。ACK = x + 1,表示确认收到(客户端发来的Seq值 + 1)，Seq = y, 表示让客户端确认是否能收到。发送完成后`服务端`进入`SYN_RCVD`状态。

**第三次握手([ACK], ACK = y + 1)**
 客户端再次发送确认包(ACK),ACK = y + 1, 表示确认收到服务器的包（服务端发来的Seq值 + 1）。`客户端`发送完毕后，进入`ESTABLISHED`状态，`服务端`接收到这个包，也进入`ESTABLISHED`状态, TCP握手结束。

# 四次挥手

![image-20230302163249132](C:\Users\Kirua\AppData\Roaming\Typora\typora-user-images\image-20230302163249132.png)

**第一次挥手（[FIN], Seq = x）**
 客户端发送一个FIN标记的包，告诉服务器需要关闭连接，表示自己不用发送数据了，但是还可以接收数据。发送完成后，`客户端`进入`FIN_WAIT_1`状态。

**第二次挥手 ([ACK], ACK = x + 1)**
 服务端发送一个ACK的确认包，告诉客户端接收到关闭的请求，但是还没有准备好。发送完成后，`服务端`进入`CLOSE_WAIT`状态，`客户端`收到这个包后，进入`FIN_WAIT_2`，等待服务器关闭连接。

**第三次挥手 ([FIN], Seq = y)**
 服务端准备好关闭连接时，发送FIN标记的包，告诉客户端准备关闭了。发送完成后，`服务端`进入`LAST_ACK`状态，等待客户端确认。

**第四次挥手 ([ACK], ACK = y + 1)**
 客户端接收到服务端的关闭请求，再发送ACK标记的确认包，进入`TIME_WAIT`状态，等待服务端可能请求重传的ACK包。
 服务端接收到ACK包后，关闭连接，进入`CLOSED`状态。
 客户端在等待固定时间(两个最大段生命周期)后，没有接收到服务的ACK包，认为服务器已关闭连接，自己也关闭连接，进入`CLOSED`状态。



# 可靠传输

确保接收到与发送的内容及顺序一致。

1. 校验：与UDP一样，增加伪首部。

2. 序号：报文段第一个字节的序号

3. 确认：期待收到的下个报文段第一个字节的序号。

   1. 停止等待协议 ：发送端每发送一次报文就等到接收端确认。
   2. 改进的停止等待协议（捎带确认）：在发送窗口的限制下，收到ACK之前不等待，连续发送报文段。让ACK带上序号，即确认号。

4. 重传

   1. 超时重传（自适应算法，动态改变RTT）

      随时测量往返时延，再加权平均。

      ARTT = （1 - α）·ARTT + α·SRTT  ， α = 1/8

      DRTT = （1 - β）·DRTT +β·|ARTT - SRTT|  ， α = 1/4

      Timeout = ARTT + 4·DRTT

   2. 冗余ACK重传

      接收方收到了大于它本身所期待序号的分组，说明有一些分组丢失了，它会发送一个冗余ACK。如果发送端已经收到了三个冗余ACK就会快速重传。否则发送端会继续发送后面的，直到接收方等待超时再重传。

# 拥塞控制

防止过多数据注入网络，保证路由器和链路不过载。

## 慢开始和拥塞避免

![image-20230302162153611](C:\Users\Kirua\AppData\Roaming\Typora\typora-user-images\image-20230302162153611.png)

① 慢开始 : 拥塞窗口 开始设置成 1 , 每隔一个 传输轮次 , 收到上一个报文段的确认报文后 , 拥塞窗口翻倍 , 即变为之前的 两倍 ;

② 慢开始门限值 ( ssthresh ) : 当 拥塞窗口 到达 慢开始门限值 ( ssthresh ) 初始值时 , 停止指数级增长 , 开始线性增长 ;

③ 拥塞避免 : 进入到 慢开始门限值 后 , 开始进行 拥塞避免算法 , 每个传输轮次 , 拥塞窗口 增加 1 ;

④ 网络拥塞 : 当 拥塞窗口 增加到一定值 , 检测到了 网络拥塞 , 此时瞬间将 拥塞窗口降为 1 ; 继续执行慢开始算法 , 新的 慢开始门限值 变为 网络拥塞时 的 拥塞窗口的 1/2 大小 ;


## 快重传和快恢复

收到3个冗余的ACK才开始进行快重传算法

![image-20230302162450768](C:\Users\Kirua\AppData\Roaming\Typora\typora-user-images\image-20230302162450768.png)

**快回复算法 :** 与 上面的 拥塞避免算法的区别是 , 出现 网络拥塞之后 , 拥塞窗口 不降为 1 , 而是降低到 慢开始门限值 , 即当前的 拥塞窗口大小的 1/2 , 然后线性增加拥塞窗口 ;